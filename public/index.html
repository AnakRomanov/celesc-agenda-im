<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
    <h1>Agendamento</h1>
    <label for="localidade">Localidade:</label>
    <select id="localidade" onchange="buscarDisponibilidade()">
        <option value="">Selecione...</option>
        <option value="Centro">Centro</option>
        <option value="Norte">Norte</option>
    </select>

    <br><br>
    <label for="data">Data:</label>
    <input type="text" id="data">

    <br><br>
    <label>
        <input type="radio" id="periodo_manha" name="periodo" value="manhã"> Manhã
    </label>
    <label>
        <input type="radio" id="periodo_tarde" name="periodo" value="tarde"> Tarde
    </label>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        let calendario;
        let turnosIndisponiveisGlobal = {};

        function calcularDataMinimaUteis(diasUteis) {
            let data = new Date();
            let count = 0;
            while (count < diasUteis) {
                data.setDate(data.getDate() + 1);
                const diaSemana = data.getDay();
                if (diaSemana !== 0 && diaSemana !== 6) {
                    count++;
                }
            }
            return data;
        }

        function inicializarCalendario(selector, options = {}) {
            return flatpickr(selector, {
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "d-m-Y",
                locale: "pt",
                ...options
            });
        }

        function aplicarBloqueiosEmCalendario(calInstance, diasArray, minDate) {
            const diasSet = new Set((diasArray || []).map(s => String(s)));
            const minD = new Date(minDate.getFullYear(), minDate.getMonth(), minDate.getDate());

            const regra = function(date) {
                const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                const key = `${y}-${m}-${dd}`;

                if (d < minD) return true;
                return diasSet.has(key) || d.getDay() === 0 || d.getDay() === 6;
            };
            calInstance.set('disable', [regra]);
        }

        async function buscarDisponibilidade() {
            const localidade = document.getElementById('localidade').value;
            if (!localidade) return;

            const resp = await fetch(`/api/disponibilidade/${localidade}`);
            const data = await resp.json();

            const diasLotados = data.diasLotados || [];
            turnosIndisponiveisGlobal = data.turnosIndisponiveis || {};

            const minDate = calcularDataMinimaUteis(3);
            calendario.set('minDate', minDate);
            aplicarBloqueiosEmCalendario(calendario, diasLotados, minDate);
        }

        function verificarDisponibilidadeTurnos() {
            const dataSelecionada = calendario.selectedDates[0]
                ? calendario.selectedDates[0].toISOString().split('T')[0]
                : null;

            if (!dataSelecionada) return;

            const periodoManha = document.getElementById('periodo_manha');
            const periodoTarde = document.getElementById('periodo_tarde');

            periodoManha.disabled = false;
            periodoTarde.disabled = false;

            if (turnosIndisponiveisGlobal[dataSelecionada]) {
                if (turnosIndisponiveisGlobal[dataSelecionada].includes('manhã')) {
                    periodoManha.disabled = true;
                }
                if (turnosIndisponiveisGlobal[dataSelecionada].includes('tarde')) {
                    periodoTarde.disabled = true;
                }
            }
        }

        window.addEventListener('load', () => {
            const minDateInit = calcularDataMinimaUteis(3);
            calendario = inicializarCalendario("#data", { onChange: verificarDisponibilidadeTurnos });
            calendario.set('minDate', minDateInit);
        });
    </script>
</body>
</html>